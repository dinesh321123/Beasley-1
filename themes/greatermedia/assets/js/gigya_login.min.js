/*! Greater Media - v0.1.0 - 2014-11-10
 * http://greatermedia.com
 * Copyright (c) 2014; * Licensed GPLv2+ */
!function(a){var b=function(a){this.config=a};b.prototype={nonceFor:function(a){return this.config[a+"_nonce"]},urlFor:function(b){var c={};c[b+"_nonce"]=this.nonceFor(b);var d=this.config.ajax_url;return d+=-1===d.indexOf("?")?"?":"&",d+=a.param(c)},request:function(b,c){c||(c={});var d=this.urlFor(b),e={action:b,action_data:JSON.stringify(c)};return a.post(d,e)}};var c=function(b,c){this.sessionData=b,this.ajaxApi=c,this.authorized=!1,this.willRegister=!1,this.mediator=a({}),gigya.accounts.addEventHandlers({onLogin:a.proxy(this.didLogin,this),onLogout:a.proxy(this.didLogout,this)})};c.prototype={get_cid:function(){return this.sessionData.cid||""},isAuthorized:function(){return this.authorized},authorize:function(){var b=this.get_cid();""!==b?gigya.accounts.getAccountInfo({cid:b,callback:a.proxy(this.gotAccountInfo,this)}):this.notify()},gotAccountInfo:function(a){0===a.errorCode?(this.authorized=!0,this.account=a):this.authorized=!1,this.notify()},on:function(a,b){this.mediator.on(a,b)},notify:function(a){a||(a="change"),this.mediator.trigger(a,this)},didLogin:function(b){this.willRegister&&this.didRegister(b),this.account=b,this.authorized=!0,this.notify();var c={UID:b.UID};this.ajaxApi.request("gigya_login",c).then(a.proxy(this.didLoginRelay,this)).fail(a.proxy(this.didLoginRelayError,this))},didLoginRelay:function(){location.reload()},didLoginRelayError:function(a){console.log("didLoginRelayError",a)},didRegister:function(b){this.willRegister=!1;var c=[];b.data.vipGroup&&c.push("VIP Newsletter"),b.data.birthdayGreetingsGroup&&c.push("Birthday Greetings"),b.data.bigFrigginDealGroup&&c.push("Big Deal");var d={UID:b.UID,listNames:c};this.ajaxApi.request("register_account",d).then(a.proxy(this.didRegisterRelay,this)).fail(a.proxy(this.didRegisterRelayError,this))},didRegisterRelay:function(a){console.log("didRegisterRelay",a),location.reload()},didRegisterRelayError:function(a){console.log("didRegisterRelayError",a)},didLogout:function(){this.authorized=!1,this.notify(),this.ajaxApi.request("gigya_logout").then(a.proxy(this.didLogoutRelay,this)).fail(a.proxy(this.didLogoutRelayError,this))},didLogoutRelay:function(a){console.log("didLogoutRelay",a),location.reload()},didLogoutRelayError:function(a){console.log("didLogoutRelayError",a)}};var d=function(b){this.session=b,this.session.on("change",a.proxy(this.didSessionChange,this)),this.container=a(".account"),this.container.on("click",a.proxy(this.didContainerClick,this))};d.prototype={render:function(){var b=this.session.isAuthorized();a(".login").css("visibility","visible"),a(".register").css("visibility",b?"hidden":"visible"),a(".login").text(b?"Logout":"Login")},didContainerClick:function(b){var c=a(b.target);return"register-button"===c.attr("id")?(this.showRegisterScreen(),!1):"login-button"===c.attr("id")?(this.session.isAuthorized()?this.showLogoutScreen():this.showLoginScreen(),!1):void 0},didSessionChange:function(){this.render()},showScreenSet:function(a){gigya.accounts.showScreenSet({screenSet:"GMR-RegistrationLogin",startScreen:a})},showLoginScreen:function(){this.showScreenSet("gigya-login-screen")},showRegisterScreen:function(){this.session.willRegister=!0,this.showScreenSet("gigya-register-screen")},showLogoutScreen:function(){gigya.accounts.logout({cid:this.session.get_cid(),callback:a.proxy(this.refresh,this)})},refresh:function(){location.reload()}},a(document).ready(function(){{var a=window.gigya_session_data.data,e=new b(a),f=new c(a,e);new d(f)}f.authorize()})}(jQuery);