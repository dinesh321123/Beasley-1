/*! Greater Media Prototype - v0.1.0 - 2014-10-09
 * http://wordpress.org/themes
 * Copyright (c) 2014; * Licensed GPLv2+ */
(function(i){var t=function(i){this.config=i};t.prototype={nonceFor:function(i){return this.config[i+"_nonce"]},urlFor:function(t){var o={};o[t+"_nonce"]=this.nonceFor(t);var e=this.config.ajax_url;return e+=-1===e.indexOf("?")?"?":"&",e+=i.param(o)},request:function(t,o){o||(o={});var e=this.urlFor(t),n={action:t,action_data:JSON.stringify(o)};return i.post(e,n)}};var o=function(t,o){this.sessionData=t,this.ajaxApi=o,this.authorized=!1,this.willRegister=!1,this.mediator=i({}),gigya.accounts.addEventHandlers({onLogin:i.proxy(this.didLogin,this),onLogout:i.proxy(this.didLogout,this)})};o.prototype={get_cid:function(){return this.sessionData.cid||""},isAuthorized:function(){return this.authorized},authorize:function(){var t=this.get_cid();""!==t?gigya.accounts.getAccountInfo({cid:t,callback:i.proxy(this.gotAccountInfo,this)}):this.notify()},gotAccountInfo:function(i){0===i.errorCode?(this.authorized=!0,this.account=i):this.authorized=!1,this.notify()},on:function(i,t){this.mediator.on(i,t)},notify:function(i){i||(i="change"),this.mediator.trigger(i,this)},didLogin:function(t){this.willRegister&&this.didRegister(t),this.account=t,this.authorized=!0,this.notify();var o={UID:t.UID};this.ajaxApi.request("gigya_login",o).then(i.proxy(this.didLoginRelay,this)).fail(i.proxy(this.didLoginRelayError,this))},didLoginRelay:function(){location.reload()},didLoginRelayError:function(i){console.log("didLoginRelayError",i)},didRegister:function(t){this.willRegister=!1;var o=[];t.data.vipGroup&&o.push("VIP Newsletter"),t.data.birthdayGreetingsGroup&&o.push("Birthday Greetings"),t.data.bigFrigginDealGroup&&o.push("Big Deal");var e={UID:t.UID,listNames:o};this.ajaxApi.request("register_account",e).then(i.proxy(this.didRegisterRelay,this)).fail(i.proxy(this.didRegisterRelayError,this))},didRegisterRelay:function(i){console.log("didRegisterRelay",i),location.reload()},didRegisterRelayError:function(i){console.log("didRegisterRelayError",i)},didLogout:function(){this.authorized=!1,this.notify(),this.ajaxApi.request("gigya_logout").then(i.proxy(this.didLogoutRelay,this)).fail(i.proxy(this.didLogoutRelayError,this))},didLogoutRelay:function(i){console.log("didLogoutRelay",i),location.reload()},didLogoutRelayError:function(i){console.log("didLogoutRelayError",i)}};var e=function(t){this.session=t,this.session.on("change",i.proxy(this.didSessionChange,this)),this.container=i(".account"),this.container.on("click",i.proxy(this.didContainerClick,this))};e.prototype={render:function(){var t=this.session.isAuthorized();i(".login").css("visibility","visible"),i(".register").css("visibility",t?"hidden":"visible"),t?i(".login").text("Logout"):i(".login").text("Login")},didContainerClick:function(t){var o=i(t.target).attr("class");switch(o){case"register":return this.showRegisterScreen(),!1;case"login":return this.session.isAuthorized()?this.showLogoutScreen():this.showLoginScreen(),!1}},didSessionChange:function(){this.render()},showScreenSet:function(i){gigya.accounts.showScreenSet({screenSet:"GMR-RegistrationLogin",startScreen:i})},showLoginScreen:function(){this.showScreenSet("gigya-login-screen")},showRegisterScreen:function(){this.session.willRegister=!0,this.showScreenSet("gigya-register-screen")},showLogoutScreen:function(){gigya.accounts.logout({cid:this.session.get_cid(),callback:i.proxy(this.refresh,this)})},refresh:function(){location.reload()}},i(document).ready(function(){var i=window.gigya_session_data.data,n=new t(i),s=new o(i,n);new e(s),s.authorize()})})(jQuery);