this.JST=this.JST||{},this.JST["src/templates/constraint_item.jst"]=function(obj){obj||(obj={});{var __t,__p="",__e=_.escape;Array.prototype.join}with(obj)__p+='<li>\n	<ul class="constraint-toolbar">\n		<li>\n			<a\n				data-id="'+__e(constraint.id)+'"\n				alt="f105"\n				class="dashicons dashicons-admin-page copy-constraint"\n				href="#"\n				title="Duplicate"\n			/>\n\n			<a\n				data-id="'+__e(constraint.id)+'"\n				alt="f105"\n				class="dashicons dashicons-trash remove-constraint"\n				href="#"\n				title="Remove"\n			/>\n		</li>\n	</ul>\n\n	<p class="constraint-title">\n		'+__e(constraint.title)+'\n	</p>\n\n	<select data-id="'+__e(constraint.id)+'" class="constraint-operator">\n		',_.each(view.operatorsFor(constraint.valueType),function(a){__p+='\n		<option value="'+__e(a)+'" '+(null==(__t=constraint.operator===a?'selected="selected"':"")?"":__t)+'">\n		'+__e(view.operatorLabelFor(a))+"\n		</option>\n		"}),__p+='\n	</select>\n\n	<input\n		type="text"\n		class="constraint-value"\n		data-id="'+__e(constraint.id)+'"\n		value="'+__e(constraint.value)+'" />\n\n	<select data-id="'+__e(constraint.id)+'" class="constraint-conjunction">\n		',_.each(view.conjunctions,function(a){__p+='\n		<option value="'+__e(a)+'" '+(null==(__t=constraint.conjunction===a?'selected="selected"':"")?"":__t)+'">\n		'+__e(a)+"\n		</option>\n		"}),__p+="\n	</select>\n</li>\n";return __p},this.JST["src/templates/constraints_menu.jst"]=function(obj){obj||(obj={});{var __p="",__e=_.escape;Array.prototype.join}with(obj)_.each(constraints,function(a,b){__p+='\n	<li>\n		<a\n			data-id="'+__e(b)+'"\n			title="Click to add" href="#" >\n			'+__e(a.title)+"\n		</a>\n	</li>\n"}),__p+="\n";return __p},this.JST["src/templates/empty_constraints.jst"]=function(obj){obj||(obj={});{var __p="";_.escape}with(obj)__p+='<li>\n	<p class="constraint-empty">Click to add filters</p>\n</li>\n';return __p},this.JST["src/templates/entry_answer.jst"]=function(obj){obj||(obj={});{var __t,__p="",__e=_.escape;Array.prototype.join}with(obj)"choice"===answerType?(__p+='\n	<select id="constraint-value-select-'+__e(constraint.id)+'" style="width: 40%">\n	',_.each(choices,function(a,b){__p+='\n		<option value="'+__e(a.value)+'" '+(null==(__t=b===currentChoice?'selected="selected"':"")?"":__t)+'">\n		'+__e(a.label)+"\n		</option>\n	"}),__p+="\n	</select>\n"):__p+='\n	<input\n		type="text"\n		class="constraint-value"\n		data-id="'+__e(constraint.id)+'"\n		id="constraint-value-input-'+__e(constraint.id)+'"\n		value="'+__e(constraint.value)+'" />\n',__p+="\n\n";return __p},this.JST["src/templates/entry_constraint_item.jst"]=function(obj){obj||(obj={});{var __t,__p="",__e=_.escape;Array.prototype.join}with(obj)__p+='<li>\n	<ul class="constraint-toolbar">\n		<li>\n			<a\n				data-id="'+__e(constraint.id)+'"\n				alt="f105"\n				class="dashicons dashicons-admin-page copy-constraint"\n				href="#"\n				title="Duplicate"\n			/>\n\n			<a\n				data-id="'+__e(constraint.id)+'"\n				alt="f105"\n				class="dashicons dashicons-trash remove-constraint"\n				href="#"\n				title="Remove"\n			/>\n		</li>\n	</ul>\n\n	<p class="constraint-title">\n		'+__e(constraint.title)+'\n	</p>\n\n	<div class="entry-select-group">\n		<label><strong>Select Contest: </strong></label>\n		<select class="entry-select-choice" id="entry-select-type-'+__e(constraint.id)+'">\n		</select>\n	</div>\n\n	<div class="entry-select-group">\n		<label><strong>Select Question: </strong></label>\n		<select class="entry-select-choice" id="entry-select-field-'+__e(constraint.id)+'">\n		</select>\n	</div>\n\n	<div class="entry-answer-group">\n		<label><strong>Select Answer: </strong></label>\n		<select data-id="'+__e(constraint.id)+'" class="constraint-operator">\n			',_.each(view.operatorsFor(constraint.valueType),function(a){__p+='\n			<option value="'+__e(a)+'" '+(null==(__t=constraint.operator===a?'selected="selected"':"")?"":__t)+'">\n			'+__e(view.operatorLabelFor(a))+"\n			</option>\n			"}),__p+='\n		</select>\n\n		<div id="entry-answer-'+__e(constraint.id)+'" style="display: inline">\n		</div>\n\n		<select data-id="'+__e(constraint.id)+'" class="constraint-conjunction">\n			',_.each(view.conjunctions,function(a){__p+='\n			<option value="'+__e(a)+'" '+(null==(__t=constraint.conjunction===a?'selected="selected"':"")?"":__t)+'">\n			'+__e(a)+"\n			</option>\n			"}),__p+="\n		</select>\n	</div>\n</li>\n";return __p},this.JST["src/templates/entry_select.jst"]=function(obj){obj||(obj={});{var __t,__p="",__e=_.escape;Array.prototype.join}with(obj)_.each(choices,function(a,b){__p+='\n	<option value="'+__e(a.value)+'" '+(null==(__t=b===currentChoice?'selected="selected"':"")?"":__t)+'">\n	'+__e(a.label)+"\n	</option>\n"}),__p+="\n";return __p},this.JST["src/templates/entry_select_type.jst"]=function(obj){obj||(obj={});{var __t,__p="",__e=_.escape;Array.prototype.join}with(obj)_.each(choices,function(a){__p+='\n	<option value="'+__e(a)+'" '+(null==(__t=a===currentChoice?'selected="selected"':"")?"":__t)+'">\n	'+__e(a)+"\n	</option>\n"}),__p+="\n";return __p},this.JST["src/templates/preview_result_row.jst"]=function(obj){obj||(obj={});var __p="",__e=_.escape;with(obj)__p+='<tr class="'+__e(index%2?"alternate":"")+'">\n	<td>\n		<a href="#" class="open-member-page-text">'+__e(account)+'</a>\n		<a href="#" alt="f105" class="dashicons dashicons-external open-member-page"></a>\n	</td>\n</tr>\n';return __p};var escapeValue=function(a){return"string"==typeof a&&(a=a.replace(/"/g,"C_DOUBLE_QUOTE"),a=a.replace(/'/g,"C_SINGLE_QUOTE"),a=a.replace(/\\/g,"C_BACKSLASH")),a},unescapeValue=function(a){return"string"==typeof a&&(a=a.replace(/C_DOUBLE_QUOTE/g,'"'),a=a.replace(/C_SINGLE_QUOTE/g,"'"),a=a.replace(/C_BACKSLASH/g,"\\")),a},getTemplate=function(a){return window.JST["src/templates/"+a+".jst"]},renderTemplate=function(a,b,c){c||(c={});var d=getTemplate(a),e=d(b);return $(e)};"function"!=typeof Object.create&&(Object.create=function(){var a=function(){};return function(b){if(arguments.length>1)throw Error("Second argument not supported");if("object"!=typeof b)throw TypeError("Argument must be an object");a.prototype=b;var c=new a;return a.prototype=null,c}}());var WpAjaxApi=function(a){this.config=a};WpAjaxApi.prototype={nonceFor:function(a){return this.config[a+"_nonce"]},urlFor:function(a){var b={};b[a+"_nonce"]=this.nonceFor(a);var c=this.config.ajax_url;return c+=-1===c.indexOf("?")?"?":"&",c+=$.param(b)},request:function(a,b){b||(b={});var c=this.urlFor(a),d={action:a,action_data:JSON.stringify(b)};return $.post(c,d)}};var Constraint=function(a){if(this.id=Constraint.nextID(),a)for(var b in a)a.hasOwnProperty(b)&&(this[b]=a[b])};Constraint.idCounter=0,Constraint.nextID=function(){return Constraint.idCounter++},Constraint.prototype={fromJSON:function(a){this.type=a.type,this.title=a.title,this.fieldPath=a.fieldPath,this.value=unescapeValue(a.value),this.valueType=a.valueType,this.operator=a.operator,this.conjunction=a.conjunction},toJSON:function(){var a={};return a.type=this.type,a.title=this.title,a.value=escapeValue(this.value),a.valueType=this.valueType,a.conjunction=this.conjunction,a.fieldPath=this.fieldPath,a.operator=this.operator,a},toGQL:function(){var a=this.fieldPath+" "+this.operator+" ";return a+="string"===this.valueType?"'"+escapeValue(this.value)+"'":this.value},clone:function(){var a=new Constraint;return a.fromJSON(this.toJSON()),a},getOperators:function(){var a=[];return"string"===this.valueType?a.push.apply(a,["contains","not contains"]):"number"===this.valueType&&a.push.apply(a,[">",">=","<","<="]),a.push.apply(a,["=","!="]),a}};var EntryConstraint=function(a){Constraint.call(this,a)};EntryConstraint.prototype=Object.create(Constraint.prototype),EntryConstraint.prototype.constructor=EntryConstraint,EntryConstraint.prototype.fromJSON=function(a){Constraint.prototype.fromJSON.call(this,a),this.entryType=a.entryType,this.entryTypeID=a.entryTypeID,this.entryFieldID=a.entryFieldID,this.entryFieldType=a.entryFieldType},EntryConstraint.prototype.toJSON=function(){var a=Constraint.prototype.toJSON.call(this);return a.entryType=this.entryType,a.entryTypeID=this.entryTypeID,a.entryFieldID=this.entryFieldID,a.entryFieldType=this.entryFieldType,a},EntryConstraint.prototype.clone=function(){var a=new EntryConstraint;return a.fromJSON(this.toJSON()),a},EntryConstraint.prototype.toGQL=function(){var a=this.pairToClause("entry_type",this.entryType)+" and ";return a+=this.pairToClause("entry_type_id",this.entryTypeID)+" and ",a+=this.pairToClause("entry_field_id",this.entryFieldID)+" and ",a+=this.pairToClause("entry_field_type",this.entryFieldType)+" and ",a+=this.pairToClause("entry_field_value",this.value,this.operator)},EntryConstraint.prototype.toFieldKey=function(a){return this.fieldPath+"."+a},EntryConstraint.prototype.pairToClause=function(a,b,c){c||(c="=");var d,e=this.toFieldKey(a),f=typeof b;return"string"===f?(d="'"+escapeValue(b)+"'",e+="_s"):(d=b,"number"===f&&(e+="_f")),e+" "+c+" "+d};var ConstraintFactory=function(){};ConstraintFactory.prototype.build=function(a){var b=this.constraintFor(a.type),c=new b;return c.fromJSON(a),c},ConstraintFactory.prototype.constraintFor=function(a){switch(a){case"entry_constraint":return EntryConstraint;default:return Constraint}},ConstraintFactory.instance=new ConstraintFactory;var factory=ConstraintFactory.instance,AVAILABLE_CONSTRAINTS=[factory.build({type:"membership_start_date",title:"Membership Start Date",fieldPath:"registeredTimestamp",value:1347872653,valueType:"number",operator:">",conjunction:"and"}),factory.build({type:"profile_location",title:"Profile Location City",fieldPath:"profile.city",value:"",valueType:"string",operator:"contains",conjunction:"and"}),factory.build({type:"profile_location",title:"Profile Location State",fieldPath:"profile.state",value:"",valueType:"string",operator:"contains",conjunction:"and"}),factory.build({type:"listening_loyalty",title:"Listening Loyalty",fieldPath:"data.listeningLoyalty",value:"Only this station",valueType:"string",operator:"contains",conjunction:"and"}),factory.build({type:"listening_frequency",title:"Listening Frequency",fieldPath:"data.listeningFrequency",value:"Once per day",valueType:"string",operator:"contains",conjunction:"and"}),factory.build({type:"entry_constraint",title:"Participation in Contest",fieldPath:"data.form_entries",value:"",valueType:"string",operator:"contains",conjunction:"and",entryType:"contest",entryTypeID:-1,entryFieldID:-1,entryFieldType:"text"})],ConstraintStore=function(){this.mediator=$({}),this.available=this.getAvailableConstraints(),this.current=this.getCurrentConstraints()};ConstraintStore.prototype={getAvailableConstraints:function(){return AVAILABLE_CONSTRAINTS},getCurrentConstraints:function(){var a,b,c,d=member_query_data.constraints||[],e=[],f=d.length;for(a=0;f>a;a++)b=d[a],c=ConstraintFactory.instance.build(b),e.push(c);return e},fromJSON:function(a){this.current=[];var b,c,d,e=a.length;for(b=0;e>b;b++)c=a[b],d=ConstraintFactory.instance.build(c),this.current.push(d);this.notify()},toJSON:function(){var a,b,c=this.current.length,d=[];for(a=0;c>a;a++)b=this.current[a],d.push(b.toJSON());return d},toGQL:function(){var a=this.current.length;if(0===a)return"";var b,c,d,e="select * from accounts where ";for(b=0;a>b;b++)c=this.current[b],d&&(e+=" "+d.conjunction),e+=" "+c.toGQL(),d=c;return e},add:function(a){var b=this.indexOf(a,this.available),c=this.available[b];c=c.clone(),this.current.push(c),this.notify()},copy:function(a){var b=this.indexOf(a),c=this.current[b],d=c.clone();this.current.splice(b,0,d),this.notify()},remove:function(a){{var b=this.indexOf(a),c=this.current[b];c.clone()}this.current.splice(b,1),this.notify()},update:function(a,b,c){var d=this.indexOf(a),e=this.current[d];e[b]=c,this.notify("updateField")},indexOf:function(a,b){b||(b=this.current);var c,d,e=b.length;for(c=0;e>c;c++)if(d=b[c],d.id===a)return c;return-1},on:function(a,b){this.mediator.on(a,b)},notify:function(a){a||(a="change"),this.mediator.trigger(a,this)}};var MemberQueryUpdater=function(a){this.store=a,this.store.on("change",$.proxy(this.didStoreChange,this)),this.store.on("inplaceChange",$.proxy(this.didStoreChange,this)),this.store.on("updateField",$.proxy(this.didUpdateField,this))};MemberQueryUpdater.prototype={didStoreChange:function(){this.update()},didUpdateField:function(){this.update()},update:function(){var a=JSON.stringify(this.store.toJSON()),b=this.store.toGQL(),c=$.trim($(".direct-query-input").val());return""!==c&&(b=c),$("#constraints").attr("value",a),$("#query").attr("value",b),b}};var MenuView=function(a){this.store=a,this.container=$(".constraints-menu"),this.container.on("click",$.proxy(this.didItemClick,this)),this.render()};MenuView.prototype={didItemClick:function(a){var b=$(a.target).attr("data-id");b&&this.addConstraint(parseInt(b,10)),a.preventDefault()},addConstraint:function(a){this.store.add(a)},render:function(){var a={view:this,constraints:this.store.available},b=renderTemplate("constraints_menu",a);this.container.html(b)}};var ConstraintItemView=function(a,b){this.container=a,this.constraint=b};ConstraintItemView.prototype={render:function(){var a={view:this,constraint:this.constraint},b=renderTemplate("constraint_item",a);this.container.append(b)},conjunctions:["and","or"],operators:{"=":"equals","!=":"not equals",">":"greater than",">=":"greater than or equal to","<":"less than","<=":"less than or equal to"},operatorLabelFor:function(a){return this.operators.hasOwnProperty(a)?this.operators[a]:a},operatorsFor:function(a){var b=["=","!="];return"number"===a?b.push.apply(b,[">",">=","<","<="]):"string"===a&&b.push.apply(b,["contains","not contains"]),b}};var EntryConstraintItemView=function(a,b){ConstraintItemView.call(this,a,b),this.entryTypes=[],this.entryFields=[]};EntryConstraintItemView.prototype=Object.create(ConstraintItemView.prototype),EntryConstraintItemView.prototype.constructor=EntryConstraintItemView;var p=EntryConstraintItemView.prototype;p.render=function(){var a={view:this,constraint:this.constraint},b=renderTemplate("entry_constraint_item",a);this.container.append(b),this.loadEntryTypes()},p.loadEntryTypes=function(){var a={entryType:"contest"};ajaxApi.request("list_entry_types",a).then($.proxy(this.didLoadEntryTypes,this)).fail($.proxy(this.didLoadEntryTypesError,this))},p.didLoadEntryTypes=function(a){this.entryTypes=a.data;var b=$("#entry-select-type-"+this.constraint.id),c=this.renderSelect(this.entryTypes,this.constraint.entryTypeID);b.html(c),b.on("change",$.proxy(this.didEntryTypeChange,this)),b.trigger("change")},p.didLoadEntryTypesError=function(a){console.log("didLoadEntryTypesError",a)},p.didEntryTypeChange=function(a){var b=$(a.target).val();this.constraint.entryTypeID=b,this.loadEntryFields(b)},p.loadEntryFields=function(a){var b={entryTypeID:a};ajaxApi.request("list_entry_fields",b).then($.proxy(this.didLoadEntryFields,this)).fail($.proxy(this.didLoadEntryFieldsError,this))},p.didLoadEntryFields=function(a){this.entryFields=a.data;var b=$("#entry-select-field-"+this.constraint.id),c=this.renderSelect(this.entryFields,this.constraint.entryFieldID);b.html(c),b.on("change",$.proxy(this.didEntryFieldChange,this)),b.trigger("change")},p.didLoadEntryFieldsError=function(a){console.log("didLoadEntryFieldsError",a)},p.didEntryFieldChange=function(a){var b=$(a.target).val(),c=this.getFieldByID(b),d=(c.type,"select"===c.type||"checkbox"===c.type?"choice":""),e={view:this,choices:c.choices,currentChoice:this.getChoiceIndex(c.choices,this.constraint.value),answerType:d,constraint:this.constraint};this.constraint.entryFieldID=c.value,this.constraint.entryFieldType=c.type;var f=renderTemplate("entry_answer",e),g=$("#entry-answer-"+this.constraint.id);if(g.html(f),this.constraint.value="","choice"===d){g.on("change",$.proxy(this.didEntryAnswerChange,this));var h=$("#constraint-value-select-"+this.constraint.id);h.trigger("change")}else{var i=$("#constraint-value-input-"+this.constraint.id);i.trigger("change")}},p.didEntryAnswerChange=function(a){var b=$(a.target),c=b.val();return this.constraint.value=c,store.notify("inplaceChange"),!1},p.getFieldByID=function(a){return _.find(this.entryFields,function(b){return b.value==a})},p.getChoiceIndex=function(a,b){for(var c=a.length,d=0;c>d;d++)if(choice=a[d],choice.value==b)return d;return-1},p.renderSelect=function(a,b){var c={view:this,id:this.constraint.id,choices:a,currentChoice:this.getChoiceIndex(a,b)},d=renderTemplate("entry_select",c);return d};var ConstraintListView=function(a){this.store=a,this.container=$(".current-constraints"),this.store.on("change",$.proxy(this.didStoreChange,this)),this.container.on("click",$.proxy(this.didItemClick,this)),this.container.on("change",$.proxy(this.didItemChange,this)),this.itemViews=[],this.render()};ConstraintListView.prototype={didItemClick:function(a){var b=$(a.target),c=b.attr("data-id");c&&(c=parseInt(c,10)),b.hasClass("remove-constraint")?this.removeConstraint(c):b.hasClass("copy-constraint")&&this.copyConstraint(c),a.preventDefault()},didItemChange:function(a){var b,c=$(a.target),d=c.attr("data-id");d&&(d=parseInt(d,10)),c.hasClass("constraint-operator")?b="operator":c.hasClass("constraint-conjunction")?b="conjunction":c.hasClass("constraint-value")&&(b="value"),b&&this.updateConstraint(d,b,c.val())},didStoreChange:function(){this.render()},copyConstraint:function(a){this.store.copy(a)},removeConstraint:function(a){this.store.remove(a)},updateConstraint:function(a,b,c){this.store.update(a,b,c)},render:function(){this.container.empty(),this.itemViews=[];var a,b,c,d=this.store.current,e=d.length;for(a=0;e>a;a++)b=d[a],c=this.listItemForConstraint(b),c.render(),this.itemViews.push(c);0===e&&this.container.append(this.emptyListItem())},listItemForConstraint:function(a){return a instanceof EntryConstraint?new EntryConstraintItemView(this.container,a):new ConstraintItemView(this.container,a)},emptyListItem:function(){return renderTemplate("empty_constraints")}};var PreviewView=function(a){this.queryUpdater=a,this.container=$(".member-query-results"),this.previewButton=$(".preview-member-query-button"),this.previewButton.on("click",$.proxy(this.didPreviewButtonClick,this))};PreviewView.prototype={didPreviewButtonClick:function(a){var b=this.queryUpdater.update();this.preview(b),a.preventDefault()},preview:function(a){return""===a?void this.setStatus("Nothing to Preview, please add some filters."):(this.setStatus("Searching, Please wait ..."),void ajaxApi.request("preview_member_query",{query:a}).then($.proxy(this.didPreviewSuccess,this)).fail($.proxy(this.didPreviewError,this)))},didPreviewSuccess:function(a){var b=a.data.accounts,c=a.data.total,d=c+" records found";d+=c>0?", showing the first 5":".",this.setStatus(d),this.render(b)},didPreviewError:function(a){this.setStatus("Failed to query records: "+a.responseJSON.data)},render:function(a){this.container.empty();var b,c,d=a.length;for(b=0;d>b;b++)c=a[b],this.container.append(this.rowForAccount(c,b))},rowForAccount:function(a,b){var c={view:this,index:b,account:a};return renderTemplate("preview_result_row",c)},setStatus:function(a){var b=$(".count-status");b.text(a)}};var $=jQuery,QueryBuilderApp=function(){$(document).ready($.proxy(this.initialize,this))};QueryBuilderApp.prototype={initialize:function(){window.ajaxApi=new WpAjaxApi(member_query_meta),this.store=window.store=new ConstraintStore,this.menuView=new MenuView(this.store),this.listView=new ConstraintListView(this.store),this.queryUpdater=new MemberQueryUpdater(this.store),this.previewView=new PreviewView(this.queryUpdater),this.previewView.preview(member_query_data.query),this.queryUpdater.update()}};var app=new QueryBuilderApp;