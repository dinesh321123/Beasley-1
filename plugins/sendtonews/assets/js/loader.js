
let table=null;let currentCategory="all";let currentSubCategory=null;let lastSearchTerm=null;let storiesCancelToken=null;let playersCancelToken=null;jQuery(document).ready(function(){sessionStorage.removeItem("sendtonews-search-reason");sessionStorage.removeItem("sendtonews-search-settings");sessionStorage.removeItem("sendtonews-current-category");sessionStorage.removeItem("sendtonews-current-subcategory");});function toggleFilters(){const filters=jQuery(".sendtonews-header-filters");if(filters.hasClass("d-none")){filters.css("display","none");filters.removeClass("d-none");}
filters.slideToggle(500);}
function ageChanged(){jQuery(".sendtonews-stories-age-dropdown").tooltip("hide");storeGlobalSearchSettings();sessionStorage.setItem("sendtonews-search-reason","age");executeSearch('age');}
function langChanged(){jQuery(".sendtonews-stories-lang-dropdown").tooltip("hide");storeGlobalSearchSettings();sessionStorage.setItem("sendtonews-search-reason","lang");var searchLang='All';const searchSettings=JSON.parse(sessionStorage.getItem("sendtonews-search-settings")||"{}");if(searchSettings){searchLang=searchSettings.lang;}
updateCategoryFilters(searchLang);executeSearch('lang');}
function executeSearch(reason){jQuery(".sendtonews-header-search .input-group").tooltip("hide");storeGlobalSearchSettings();sessionStorage.setItem("sendtonews-search-reason","search");executeRefreshStories(reason);}
function storeGlobalSearchSettings(){sessionStorage.setItem("sendtonews-search-settings",JSON.stringify({search:jQuery(".sendtonews-stories-search-input").val(),age:jQuery(".sendtonews-stories-age-dropdown").val(),lang:jQuery(".sendtonews-stories-lang-dropdown").val()}));}
function executeRefreshStories(reason){jQuery(".sendtonews-stories-refresh-button").tooltip("hide");if(refreshStories){refreshStories.call(null,reason,true);}}
async function updatePlayersSelect(){const playersContainer=jQuery('#sendtonews-players-select');if(!playersContainer.length){return;}
if(playersCancelToken){return;}
playersCancelToken=new CancelToken();try{const ajaxRequest=new AjaxRequest(sendtonews_loader_i18n.api_url+"players","POST");ajaxRequest.data.cid=sendtonews_loader_i18n.cid;ajaxRequest.data.authcode=sendtonews_loader_i18n.authcode;const response=await ajaxRequest.send(playersCancelToken);if(!response.success){let e=new Error();if(response.errors){const keys=Object.keys(response.errors);if(keys.length){e=Error(response.errors[keys[0]]);}}
e.status="Bad Request";throw e;}
if(response.players){players=response.players;await generatePlayersSelect(players,playersContainer);}else{let e=new Error();e.status="Empty Response";e.message="No players available.";throw e;}}
catch(e){if(e instanceof CancellationError){return;}else{const message=(e.response&&e.response.message)||(e.message)||"Unknown Error";console.log(`Error occurred while loading players. ${e.status} : ${message}`);playersContainer.empty().html(`Error occurred while loading players. ${e.status} : ${message}`);jQuery('.sendtonews-api-auth-notice').removeClass('d-none');}}
if(playersCancelToken&&playersCancelToken.isCancelled){console.log('Players selection update was cancelled.');return;}
playersCancelToken=null;}
let playersTypeMapping={'FULL2':'full','FLOAT':'player'};async function generatePlayersSelect(players,playersContainer){let playersMapping={};let playerSelector='<!-- Players Selector -->';playerSelector='<div id="players-selector" class="input-group">';playerSelector+='<select class="custom-select dropdown" id="players-select">';let playerSelected;if(window.location.href.indexOf("widgets.php")>-1){playerSelected=localStorage.getItem('sendtonews-selected-player-widget');}else{playerSelected=localStorage.getItem('sendtonews-selected-player');}
playerSelector+='<option value="">Select a Playerâ€¦</option>';for(let playerIndex=0;playerIndex<players.length;playerIndex++){playersMapping[players[playerIndex]['id']]=players[playerIndex];if(playerSelected=="["+players[playerIndex]['contentGroup']['name']+"]"+" "+players[playerIndex]['name']){playerSelector+=`<option value="${players[playerIndex]['id']}" selected>[${players[playerIndex]['contentGroup']['name']}] ${players[playerIndex]['name']}</option>`;}else{playerSelector+=`<option value="${players[playerIndex]['id']}">[${players[playerIndex]['contentGroup']['name']}] ${players[playerIndex]['name']}</option>`;}}
playerSelector+='</select>';playerSelector+='<div class="input-group-append">';playerSelector+='<button onclick="recordPlayerSubmit()" id="players-submit" class="btn btn-outline-secondary btn-dual btn-disabled insert-player" type="button" disabled="disabled" data-toggle="tooltip" title="Insert Selected Player Embed">Insert Player</button>';playerSelector+='</div>';playerSelector+='</div>';playersContainer.empty().html(playerSelector);let playersSelect=playersContainer.find('#players-select');let playersSubmit=playersContainer.find('#players-submit');playersSelect.change(function(){if(this.value==''){playersSubmit.removeAttr('data-embedname');playersSubmit.removeAttr('data-embedtype');playersSubmit.removeAttr('data-embedkey');playersSubmit.addClass('btn-disabled');playersSubmit.attr('disabled','disabled');}else{playersSubmit.attr('data-embedname','['+playersMapping[this.value]['contentGroup']['name']+'] '+playersMapping[this.value]['name']);playersSubmit.attr('data-embedtype',playersTypeMapping[playersMapping[this.value]['type']]);playersSubmit.attr('data-embedkey',playersMapping[this.value]['esgKey']);playersSubmit.removeClass('btn-disabled');playersSubmit.removeAttr('disabled');}});playersContainer.find('[data-toggle="tooltip"]').mobileTooltip();}
let categoriesCancelToken=null;let categories={"display":[{"name":"all","displayName":"All","subCategoryGroups":[]}],"data":{"all":1}};async function updateCategoryFilters(lang,categoriesCancelToken){const filtersContainer=jQuery('#sendtonews-category-filters');if(!filtersContainer.length){return;}
try{const ajaxRequest=new AjaxRequest(sendtonews_loader_i18n.api_url+"categories","POST");ajaxRequest.data.cid=sendtonews_loader_i18n.cid;ajaxRequest.data.authcode=sendtonews_loader_i18n.authcode;ajaxRequest.data.lang=lang;const response=await ajaxRequest.send(categoriesCancelToken);if(!response.success){let e=new Error();if(response.errors){const keys=Object.keys(response.errors);if(keys.length){e=Error(response.errors[keys[0]]);}}
e.status="Bad Request";throw e;}
if(response.categories){currentCategory='all';currentSubCategory=null;categories=response.categories.display;await generateCategoriesFilters(categories,filtersContainer);}else{let e=new Error();e.status="Empty Response";e.message="No players available.";throw e;}}
catch(e){if(e instanceof CancellationError){return;}else{const message=(e.response&&e.response.message)||(e.message)||"Unknown Error";console.log(`Error occurred while loading categories. ${e.status} : ${message}`);filtersContainer.empty().html(`Error occurred while loading categories. ${e.status} : ${message}`);jQuery('.sendtonews-api-auth-notice').removeClass('d-none');}}
if(categoriesCancelToken&&categoriesCancelToken.isCancelled){console.log('Category Filters update was cancelled.');return;}
categoriesCancelToken=null;}
async function generateCategoriesFilters(categories,filtersContainer){let filters='<!-- Main Filters -->';filters='<ul id="category-nav" class="nav pt-2 px-2">';for(let catIndex=0;catIndex<categories.length;catIndex++){filters+=generateCategory(categories[catIndex],catIndex);}
filters+='<span class="flex-grow-1"></span>';filters+='</ul>';filters+='<!-- Sub Filters -->';filters+='<div class="tab-content px-3">';for(subcatIndex=0;subcatIndex<categories.length;subcatIndex++){filters+=generateSubCategory(categories[subcatIndex],subcatIndex);}
filters+='</div>';filtersContainer.empty().html(filters);}
function generateCategory(category,catIndex){let categoryHTML='';let isActive='';let sessionCategory=sessionStorage.getItem("sendtonews-current-category");let sessionSubCategoryGroup='';let categoryID=category['displayName'].toLowerCase().replace(" ","-");if(sessionCategory&&sessionCategory.includes("-")){let sessionCategories=sessionCategory.split("-");sessionCategory=sessionCategories[0];sessionSubCategoryGroup=sessionCategories[1];}
if((sessionCategory&&sessionCategory===category.name)||(!sessionCategory&&0===catIndex)){isActive='active ';}
if(category['subCategoryGroups'].length>1){categoryHTML+=`
<li class="nav-item dropdown">
    <a id="${categoryID}" class="nav-link ${isActive} dropdown-toggle" data-toggle="dropdown" href="#" aria-haspopup="true" aria-expanded="false">${category['displayName']}</a>
    <div class="dropdown-menu" aria-labelledby="${categoryID}">`;for(let subcatGroupIndex=0;subcatGroupIndex<category['subCategoryGroups'].length;subcatGroupIndex++){let isGroupActive='';if(sessionSubCategoryGroup===category['subCategoryGroups'][subcatGroupIndex].name){isGroupActive=' active';}
categoryHTML+=generateSubCategoryGroupDropdown(category['subCategoryGroups'][subcatGroupIndex],category,subcatGroupIndex,isGroupActive);}
categoryHTML+='</div></li>';}else{let containerSlug='';if(category['subCategoryGroups'].length===1){containerSlug='-'+category['subCategoryGroups'][0]['name'];if(sessionCategory===category['subCategoryGroups'][0]['name']){isActive=' active';}}
categoryHTML+=`
<li class="nav-item">
    <a class="nav-link ${isActive}" onclick="categoryClicked(this)" data-toggle="tab" data-cat="${category['name']}" href="#cat-${category['name']}${containerSlug}-container">${category['displayName']}</a>
</li>`;}
return categoryHTML;}
function generateSubCategoryGroupDropdown(subCategoryGroup,category,subcatGroupIndex,active=''){return`<a class="dropdown-item${active}" onclick="categoryClicked(this)" data-toggle="tab" data-cat="${category['name']}-${subCategoryGroup['name']}" href="#cat-${category['name']}-${subCategoryGroup['name']}-container"> by ${subCategoryGroup['displayName']}</a>`;}
function generateSubCategory(category,subcatIndex){let subCategoryHTML='';let isActive='';let sessionCategory=sessionStorage.getItem("sendtonews-current-category");let sessionSubCategoryGroup='';if(sessionCategory&&sessionCategory.includes("-")){let sessionCategories=sessionCategory.split("-");sessionCategory=sessionCategories[0];sessionSubCategoryGroup=sessionCategories[1];}
if((sessionCategory&&sessionCategory===category.name)||(!sessionCategory&&0===subcatIndex)){isActive='active show';}
if(category['subCategoryGroups'].length>0){for(let sindex=0;sindex<category['subCategoryGroups'].length;sindex++){subCategoryHTML+=generateSubCategoryGroup(category['subCategoryGroups'][sindex],category,subcatIndex,sindex);}}else{subCategoryHTML+=`<div class="tab-pane ${isActive} fade py-2 cat" id="cat-${category['name']}-container" cat="${category['name']}"></div>`;}
return subCategoryHTML;}
function generateSubCategoryGroup(subCategoryGroup,category,subcatIndex,sindex){let subCategoryGroupHTML='';let isActive='';let isSubActive=' active';let sessionCategory=sessionStorage.getItem("sendtonews-current-category");let sessionSubCategory=sessionStorage.getItem("sendtonews-current-subcategory");let sessionSubCategoryGroup='';if(sessionCategory&&sessionCategory.includes("-")){let sessionCategories=sessionCategory.split("-");sessionCategory=sessionCategories[0];sessionSubCategoryGroup=sessionCategories[1];}
if(((sessionCategory&&sessionCategory===category.name&&!sessionSubCategoryGroup)||(sessionCategory&&sessionCategory===category.name&&sessionSubCategoryGroup&&sessionSubCategoryGroup===subCategoryGroup['name']))||(!sessionCategory&&0===subcatIndex)){isActive='active show ';}
if(sessionSubCategory&&sessionSubCategory!='all'){isSubActive='';}
subCategoryGroupHTML+=`
<div class="tab-pane ${isActive} fade py-2 cat" id="cat-${category['name']}-${subCategoryGroup['name']}-container" cat="${category['name']}" group="${subCategoryGroup['name']}">
    <div class="d-flex d-sm-none">`;if(category['subCategoryGroups'].length>1){subCategoryGroupHTML+=`<span class="ml-3">${subCategoryGroup['displayName']}s:</span>`;}
subCategoryGroupHTML+=`</div>
        <div id="sub-cat-${category['name']}-${subCategoryGroup['name']}-container">
                        <button class="btn btn-sm btn-outline-secondary sub-cat m-1${isSubActive}" onclick="subCategoryClick(this);" sub-cat="all">All</button>`;for(let dindex=0;dindex<subCategoryGroup['subCategories'].length;dindex++){if(sessionSubCategory&&sessionSubCategory===subCategoryGroup['subCategories'][dindex]['name']){isSubActive=' active';}else{isSubActive='';}
subCategoryGroupHTML+=`<button class="btn btn-sm btn-outline-secondary sub-cat m-1${isSubActive}" onclick="subCategoryClick(this);" sub-cat="${subCategoryGroup['subCategories'][dindex]['name']}">${subCategoryGroup['subCategories'][dindex]['displayName']}</button>`}
subCategoryGroupHTML+='</div></div>';return subCategoryGroupHTML;}
async function categoryClicked(element){if(jQuery(element).hasClass("active")){return;}
const category=jQuery(jQuery(element).attr("href"));currentCategory=category.attr("cat");const categoryHandle=jQuery(element).attr("data-cat");sessionStorage.setItem("sendtonews-current-category",categoryHandle);const subCategory=category.find("[sub-cat=all]");setCurrentSubCategory(subCategory,category);await refreshStories("category",true);}
async function subCategoryClick(subCategory){subCategory=jQuery(subCategory);if(subCategory.hasClass("active")){return false;}
setCurrentSubCategory(subCategory,subCategory.parents(".cat"));await refreshStories("subcategory",true);}
function setCurrentSubCategory(subCategory,category){currentSubCategory=subCategory.attr("sub-cat");if(currentSubCategory){sessionStorage.setItem("sendtonews-current-subcategory",currentSubCategory);}else{sessionStorage.setItem("sendtonews-current-subcategory",'');}
category.find(".sub-cat").removeClass("active");subCategory.addClass("active");category.find(".mobile-sub-cat-list i").text(subCategory.text());}
let storyViewCollection=new StoryViewCollection();let moreStories=true;function resetStoryViewCollection(){moreStories=true;storyViewCollection=new StoryViewCollection();}
async function loadMoreStories(reason,storiesCancelToken){const storiesContainer=jQuery("#stories-container");const offset=storyViewCollection.length;const length=50;let sessionCategory=sessionStorage.getItem("sendtonews-current-category");let sessionSubCategory=sessionStorage.getItem("sendtonews-current-subcategory");let sessionSubCategoryGroup='';if(sessionCategory&&sessionCategory.includes("-")){let sessionCategories=sessionCategory.split("-");sessionCategory=sessionCategories[0];sessionSubCategoryGroup=sessionCategories[1];}
let storyViews;try{const searchSettings=JSON.parse(sessionStorage.getItem("sendtonews-search-settings")||"{}");const ajaxRequest=new AjaxRequest(sendtonews_loader_i18n.api_url+"stories","POST");ajaxRequest.data.search=lastSearchTerm=searchSettings.search||null;ajaxRequest.data.age=lastSearchAge=searchSettings.age||1;ajaxRequest.data.lang=lastSearchLang=searchSettings.lang||'EN';ajaxRequest.data.category=sessionCategory||'all';ajaxRequest.data.subCategory=sessionSubCategory||'';ajaxRequest.data.start=offset;ajaxRequest.data.length=length+1;ajaxRequest.data.reason=reason;const response=await ajaxRequest.send(storiesCancelToken);if(!response.success){let e=new Error();if(response.errors){const keys=Object.keys(response.errors);if(keys.length){e=Error(response.errors[keys[0]]);}}
e.status="Bad Request";throw e;}
const stories=response.stories.slice(0,length);storyViews=stories.map((s,i)=>createStoryView(s,offset+i));if(response.stories.length!==length+1){jQuery("#stories-load-more").removeClass("load-more-shown").addClass("load-more-hidden");moreStories=false;}}
catch(e){if(e instanceof CancellationError){return;}else{const message=(e.response&&e.response.message)||(e.message)||"Unknown Error";storiesContainer.append(`<div class="p-3" index="none"><b class="text-danger">Error occurred while loading content. ${e.status} : ${message} </b></div>`);jQuery("#stories-load-more").addClass('d-none');jQuery('.sendtonews-api-auth-notice').removeClass('d-none');return;}}
if(storiesCancelToken&&storiesCancelToken.isCancelled){return;}
if(!offset&&!storyViews.length){storiesContainer.append(`<div class="p-3" index="none">No results found${lastSearchTerm ? ' for \'' : '.' }<b>${lastSearchTerm ? escapeHtml(lastSearchTerm) + '\'.' : ''}</b></div>`);}else{for(let i=0;i<storyViews.length;i++){const view=storyViews[i].getView();storiesContainer.append(view);}}}
function createStoryView(story,index){return storyViewCollection.createStoryView(story,index);}
let loading=false;let scrolled=false;let storiesScrollChecker=null;async function storiesScrollCheck(){if(scrolled){await populateStories("scroll");scrolled=false;}}
async function populateStories(reason,storiesCancelToken){if(loading){return;}
try{const scrollThreshold=2000;const scrollCeiling=jQuery('#stories-container').offset().top;const loadMoreCeiling=jQuery("#stories-load-more").offset().top;if(moreStories&&(loadMoreCeiling<scrollThreshold)&&reason!=="wait"){await populateStories("wait");loading=true;await loadMoreStories(reason,storiesCancelToken);return;}
if(storyViewCollection.canRollPopulatedRegionUp()){if(!storyViewCollection.firstPopulated)
{return;}
const firstPopulatedOffset=storyViewCollection.firstPopulated.offset;if(-1*firstPopulatedOffset<scrollThreshold){loading=true;storyViewCollection.rollPopulatedRegionUp();loading=false;await populateStories(reason);return;}}
if(storyViewCollection.canRollPopulatedRegionDown()){if(!storyViewCollection.lastPopulated)
{return;}
const lastPopulatedOffset=storyViewCollection.lastPopulated.offset;if(lastPopulatedOffset<scrollThreshold){loading=true;storyViewCollection.rollPopulatedRegionDown();loading=false;await populateStories(reason);return;}}}
finally{loading=false;}}
async function refreshStories(reason,force=false){if(!jQuery('#sendtonews-stories').length){return;}
if(storiesCancelToken){if(force){storiesCancelToken.cancel();await storiesCancelToken.onCancelled;}else{return;}}
storiesCancelToken=new CancelToken();resetStoryViewCollection();const storiesContainer=jQuery("#stories-container");storiesContainer.empty();jQuery("#stories-load-more").removeClass("load-more-hidden").addClass("load-more-shown");await populateStories(reason,storiesCancelToken);storiesCancelToken=null;}
jQuery(document).on('keyup',".sendtonews-stories-search-input",onSearchChanged);function onSearchChanged(){const search=jQuery(".sendtonews-stories-search-input");if(!search.val()){jQuery('.sendtonews-header-search').removeClass('searching');jQuery(".sendtonews-clear-stories-search").addClass('d-none');}else{jQuery('.sendtonews-header-search').addClass('searching');jQuery(".sendtonews-clear-stories-search").removeClass('d-none');}}
jQuery(document).on('click',".sendtonews-clear-stories-search",onSearchClear);function onSearchClear(){jQuery('.sendtonews-header-search').removeClass('searching');jQuery(".sendtonews-stories-search-input").val('').focus();onSearchChanged();const lastSearch=JSON.parse(sessionStorage.getItem("sendtonews-search-settings")||"{}").search;if(lastSearch){executeSearch();}}