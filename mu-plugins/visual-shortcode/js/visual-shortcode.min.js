!function(a){String.prototype.trim||!function(){var a=/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g;String.prototype.trim=function(){return this.replace(a,"")}}();var b=function(){this.toHTMLFragmentProxy=a.proxy(this.toHTMLFragment,this),this.replaceShortcodeProxy=a.proxy(this.replaceShortcode,this)};b.prototype={toHTML:function(a){var b=wp.shortcode.replace(this.plugin.getShortcodeTag(),a,this.toHTMLFragmentProxy);return b=this.replaceEmptyBody(b)},toShortcode:function(b){var c=a("<div></div>");c.html(b);var d=this.getSelector(),e=a(d,c);if(e.length>0){e.each(this.replaceShortcodeProxy);var f=c.html();return f}return b},toHTMLFragment:function(b){var c=b.attrs.named,d=this.toDataAttrs(c);d["class"]=this.plugin.getClassName();var e=a("<div></div>",d),f=a("<span></span>",{"class":"meta",contenteditable:!1}),g=a("<div></div>",{"class":"body"}),h=b.content;h=this.replaceTrailingPara(h),g.html(h),f.html(this.plugin.getMetaLabel(c)),e.data("status",c.status),e.append(f),e.append(g);var i=e.prop("outerHTML");return i},toDataAttrs:function(a){var b={};for(var c in a)a.hasOwnProperty(c)&&(b["data-"+c]=a[c]);return b},replaceShortcode:function(b,c){var d=a(c),e=this.plugin.nodeForTarget(c),f=a(".body",d),g=this.plugin.getDataFromNode(e),h=new wp.shortcode({tag:this.plugin.getShortcodeTag(),attrs:g,type:this.plugin.getType(),content:f.html()}),i=h.string();i=this.collapseNbsp(i),d.replaceWith(i)},replaceEmptyBody:function(a){return a=a.replace('<div class="body">&nbsp;</div>',"")},replaceTrailingPara:function(a){return a=a.trim(),a=a.replace(/<br \/>$/,""),a=a.replace(/<p>$/,""),a=a.trim(),a=a.replace(/<\/p>$/,"")},collapseNbsp:function(a){return a.replace(/(&nbsp;)+/,"&nbsp;")},getSelector:function(){return"."+this.plugin.getClassName()}};var c=function(){};c.prototype={plugin:null,button:null,register:function(){for(var a,b=this.plugin.getEditor(),c=this.plugin.getCommand(),d=this.getButtons(),e=0;e<d.length;e++)a=d[e],b.addButton(c,a)},getButtons:function(){var a=this;return[{title:this.plugin.getDisplayName(),cmd:this.plugin.getCommand(),image:"",onPostRender:function(){a.button=this}}]},setEnabled:function(a){this.button&&this.button.disabled(!a)}};var d=function(){};d.prototype={plugin:null,win:null,data:{},activeNode:null,isNew:!0,open:function(){var b=this.plugin.getEditor(),c=this.getParams(),d=b.windowManager;if(this.activeNode=this.plugin.getSelectedNode(),this.win=d.open(c),!this.data.isNew){var e=a("#content-restricted-remove-button");e.css("left","10px")}this.didOpen()},close:function(){this.win.close()},didOpen:function(){},didSubmit:function(b){var c=b.data,d=this.plugin,e=d.getEditor();if(this.plugin.isFocussed()){var f=d.getFocusState(),g=(f.value,f.target),h=a(g),i=a(".meta",h),j=this.plugin.nodeForTarget(g);this.plugin.saveDataToNode(j,c),i.html(this.plugin.getMetaLabel(c))}else{var k=this.plugin.getSelectedText(),l=new wp.shortcode({tag:this.plugin.getShortcodeTag(),attrs:c,type:this.plugin.getType(),content:k}),m=l.string();e.execCommand("mceInsertContent",!1,m)}e.selection.collapse()},didClose:function(a){},didRemove:function(b){var c=a(this.activeNode),d=this.plugin.getClassName();if(c.hasClass(d))c.removeClass(d);else if($parent=c.parents("."+d),0!==$parent.length){var e=a(".body",$parent);$parent.replaceWith(e.html())}this.close()},getData:function(){return this.data},getParams:function(){var b=this.getSize(),c={title:this.getTitle(),width:b.width,height:b.height,buttons:this.getButtons(this.isNew),body:this.getBody(),onsubmit:a.proxy(this.didSubmit,this),onclose:a.proxy(this.didClose,this)};return c},getSize:function(){return{width:400,height:100}},getTitle:function(){return"abstract:Dialog"},getButtons:function(b){var c=[{text:"Ok",onclick:"submit"},{text:"Cancel",onclick:"close"}];return b||c.unshift({text:"Remove",id:"content-restricted-remove-button",onclick:a.proxy(this.didRemove,this)}),c},getBody:function(a){return"abstract"}};var e=function(a){this.groupID=a,this.plugins=[],this.registered=!1};e.prototype={add:function(a){this.plugins.push(a),this.register(a)},register:function(b){if(!this.registered){var c=b.getEditor();c.on("NodeChange",a.proxy(this.didNodeChange,this)),this.registered=!0}},didNodeChange:function(a){var b,c,d=this.groupHasFocus(),e=this.plugins.length;for(b=0;e>b;b++)c=this.plugins[b],c.setEnabled(c.isFocussed()?!0:d?!1:!0)},groupHasFocus:function(){var a,b,c=this.plugins.length;for(a=0;c>a;a++)if(b=this.plugins[a],b.isFocussed())return!0;return!1}};var f=function(){};f.prototype={getName:function(){return"shortcodePlugin"},getPluginName:function(){return this.getName().replace("-","")},getShortcodeTag:function(){return this.getName()},getClassName:function(){return this.getShortcodeTag()},getDisplayName:function(){return"Shortcode Plugin"},getCommand:function(){return this.getName()},getGroupID:function(){return this.group.groupID},getNamespace:function(){return"tinymce.plugins."+this.getPluginName()},getType:function(){return"closed"},getMetaLabel:function(a){return"abstract:meta-label"},getConvertor:function(){return this.convertor||(this.convertor=new b,this.convertor.plugin=this),this.convertor},getDialog:function(){var a=new d;return a.plugin=this,a},getMenu:function(){var a=new c;return a.plugin=this,a},getEditor:function(){return this.editor},getSelection:function(){return this.getEditor().selection},getSelectedNode:function(){return this.getSelection().getNode()},getSelectedText:function(){return this.getSelection().getContent()},getSelectedData:function(){var a=this.getFocusState(),b=a.target;if(b){var c=this.nodeForTarget(b);return this.getDataFromNode(c)}return{}},getFocusState:function(){var b=this.getSelectedNode(),c=a(b),d=this.getClassName(),e="outside",f=null;if(c.hasClass(d))e="at",f=b;else{var g=c.parents("."+d);0!==g.length&&(e="inside",f=g)}return{value:e,target:f}},isFocussed:function(){var a=this.getFocusState();return"at"===a.value||"inside"===a.value},setEnabled:function(a){this.menu.setEnabled(a)},initialize:function(){this.editor.addCommand(this.getCommand(),this.callback("didCommand")),this.menu=this.getMenu(),this.menu.register(),this.editor.on("NodeChange",this.callback("didNodeChange")),this.editor.on("BeforeSetContent",this.callback("didBeforeSetContent")),this.editor.on("PostProcess",this.callback("didPostProcess")),this.editor.on("KeyDown",this.callback("didKeyDown"))},didCommand:function(){var a=this.getDialog();a.data=this.getSelectedData(),a.isNew=!this.isFocussed(),a.open()},didNodeChange:function(b){var c=this.isFocussed();this.editor.controlManager.setActive(this.getCommand(),c);var d=this.getFocusState(),e=d.target,f=this.getClassName()+"-focus";if(this.$prevTarget&&this.$prevTarget.toggleClass(f,!1),e){var g=a(e);g.toggleClass(f,!0),this.$prevTarget=g}},didBeforeSetContent:function(a){if(content){var b=this.getConvertor();a.content=b.toHTML(a.content)}},didPostProcess:function(a){if(a.get){var b=this.getConvertor();a.content=b.toShortcode(a.content)}},didKeyDown:function(b){if(13===b.keyCode&&!b.shiftKey){var c=this.getFocusState();if("outside"!==c.value){var d,e,f=c.target,g=f.get(0),h=tinymce.DOM.createRng();return g.nextSibling?d=g.nextSibling:(e=a("<p>&nbsp;</p>"),f.after(e),d=e.get(0)),h.setStart(d,0),e?h.setEnd(d,1):h.setEnd(d,0),this.editor.selection.setRng(h),b.preventDefault(),b.stopPropagation(),!1}}return!0},callback:function(b){return a.proxy(this[b],this)},nodeForTarget:function(a){return a instanceof jQuery?a.get(0):a},saveDataToNode:function(a,b){for(var c in b)b.hasOwnProperty(c)&&a.setAttribute("data-"+c,b[c])},getDataFromNode:function(a){var b,c,d,e={},f=/^data-/,g=a.attributes,h=g.length,i="data-".length;for(b=0;h>b;b++)attribute=g[b],d=attribute.name,f.test(d)&&(c=d.substring(i),e[c]=attribute.value);return e}};var g=function(){this.pluginGroups={}};g.prototype={register:function(a,b){var c=this,d=function(a,d){return c.build(a,d,b)};tinymce.PluginManager.add(a,d)},build:function(a,b,c){var d=new c,e=a.id;return d.editor=a,d.editorUrl=b,d.group=this.store(e,d),d.initialize(),d},store:function(a,b){this.pluginGroups[a]||(this.pluginGroups[a]=new e(a));var c=this.pluginGroups[a];return c.add(b),c}},g.instance=new g,window.VisualShortcodeRedux={Convertor:b,Menu:c,Dialog:d,Plugin:f,PluginFactory:g,PluginGroup:e,registerPlugin:function(a,b){return this.factory||(this.factory=new g),this.factory.register(a,b)}}}(jQuery);